name: Build & Deploy Workflow

on:
  push:
    branches:
      - master
      - dev

jobs:
  build_and_deploy:
    name: ğŸ”§ Build & ğŸš€ Deploy on Push to Master/Dev
    runs-on: macos-latest

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ“ Get Last Commit Message
        id: last_commit
        run: echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

      - name: Set Target Branch
        id: set_target_branch
        run: |
          current_branch="${GITHUB_REF##*/}"
          echo "Current branch: $current_branch"
          if [ "$current_branch" == "master" ]; then
            echo "TARGET_BRANCH=master-build" >> $GITHUB_ENV
          elif [ "$current_branch" == "dev" ]; then
            echo "TARGET_BRANCH=dev-build" >> $GITHUB_ENV
          else
            echo "Error: Push from unrecognized branch: $current_branch. Exiting."
            exit 1
          fi

      #####################################
      # â™»ï¸ Restore Caches (npm + composer)
      #####################################

      - name: â™»ï¸ Restore NPM + node_modules Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
          key: npm-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-${{ github.ref_name }}-

      - name: â™»ï¸ Restore Composer vendor Cache
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-${{ github.ref_name }}-

      - name: â™»ï¸ Restore Homebrew Cache
        uses: actions/cache@v3
        with:
          path: |
            /usr/local/Homebrew
            /opt/homebrew
          key: brew-${{ runner.os }}-${{ github.ref_name }}
          restore-keys: |
            brew-${{ runner.os }}-

      #####################################
      # âš™ï¸ Environment Setup
      #####################################

      - name: âš™ï¸ Install PHP & Composer via Homebrew
        run: |
          echo "ğŸ”§ Installing PHP..."
          brew install php || echo "âœ… PHP already installed"

          echo "ğŸ“¦ Installing Composer..."
          brew install composer || echo "âœ… Composer already installed"

      #####################################
      # ğŸ“¥ Install Dependencies
      #####################################

      - name: ğŸ“¥ Install Project Dependencies
        run: |
          echo "ğŸ“¦ Installing Composer dependencies..."
          composer install --prefer-dist --no-progress --no-suggest

          echo "ğŸ“¦ Installing NPM dependencies..."
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "âš ï¸ package-lock.json not found, using npm install instead"
            npm install
          fi

      #####################################
      # ğŸ› ï¸ Build + Lint
      #####################################

      - name: ğŸ› ï¸ Build Assets & Lint PHP
        run: |
          echo "ğŸ—ï¸ Running npm build script..."
          npm run build || exit 1

          echo "ğŸ§¹ Running PHPCBF to auto-fix code style..."
          set +e
          ./vendor/bin/phpcbf . -d memory_limit=1024M
          result=$?
          if [ $result -ne 0 ]; then
            echo "â„¹ï¸ PHPCBF fixed some issues. Continuing..."
          fi
          set -e

      #####################################
      # ğŸ’¾ Save Caches AFTER install
      #####################################

      - name: ğŸ’¾ Save Composer vendor Cache
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-${{ github.ref_name }}-

      - name: ğŸ’¾ Save node_modules + .npm Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
          key: npm-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-${{ github.ref_name }}-

      - name: ğŸ’¾ Save Homebrew Cache
        uses: actions/cache@v3
        with:
          path: |
            /usr/local/Homebrew
            /opt/homebrew
          key: brew-${{ runner.os }}-${{ github.ref_name }}

      #####################################
      # ğŸ§¼ Cleanup
      #####################################

      - name: ğŸ§¼ Cleanup Unnecessary Files
        run: |
          echo "ğŸ§¹ Cleaning up unnecessary build files..."
          rm -rf ./plugins/wisesync/blocks/src
          rm -rf ./themes/papersync/blocks/src

      #####################################
      # ğŸš€ Deploy
      #####################################

      - name: ğŸš€ Deploy to Target Build Branch
        run: |
          echo "ğŸšš Preparing deployment to $TARGET_BRANCH branch..."
          git clone --single-branch --branch $TARGET_BRANCH https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git deploy

          echo "ğŸ“ Updating build files in deploy directory..."
          rm -rf deploy/plugins
          rm -rf deploy/themes
          cp -r plugins deploy/
          cp -r themes deploy/

          cd deploy
          git config user.name "Shubham Kumar Bansal"
          git config user.email "shub@shubkb.com"

          echo "ğŸ“ Committing build changes..."
          git add .
          git commit -m "Deploy build: $(date +'%Y-%m-%d %H:%M:%S') - ${{ steps.last_commit.outputs.message }}" || echo "âœ… No changes to commit"

          echo "ğŸš€ Pushing to $TARGET_BRANCH branch..."
          git push origin $TARGET_BRANCH
