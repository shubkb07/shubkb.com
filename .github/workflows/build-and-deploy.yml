name: Build and Deploy

on:
  push:
    branches:
      - master

jobs:
  # Job to set up PHP, cache & install Composer dependencies, and install WP-CLI via brew.
  php_setup:
    runs-on: macos-latest
    steps:
      - name: Check Out Code
        uses: actions/checkout@v3

      - name: Setup PHP Environment
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'

      - name: Cache Composer Dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Composer Install
        run: |
          echo "Installing Composer dependencies..."
          composer install --prefer-dist --no-progress --no-suggest

      - name: Install WP-CLI using Homebrew
        run: |
          echo "Installing WP-CLI using Homebrew..."
          brew update && brew install wp-cli
          echo "WP-CLI installed successfully."

  # Job to set up Node, cache & install npm dependencies.
  node_setup:
    runs-on: macos-latest
    steps:
      - name: Check Out Code
        uses: actions/checkout@v3

      - name: Setup Node Environment
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: npm Install
        run: |
          echo "Installing NPM dependencies..."
          npm install

  # Final build job depends on php_setup and node_setup.
  build:
    needs: [php_setup, node_setup]
    runs-on: macos-latest
    steps:
      - name: Check Out Code
        uses: actions/checkout@v3

      - name: Setup PHP Environment
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'

      - name: Setup Node Environment
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      - name: Cache Node Modules (Build)
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: npm Install (Build)
        run: |
          echo "Installing Node dependencies for build..."
          npm install

      - name: Final Build Step
        run: |
          echo "Starting final build..."
          echo "Running npm run build..."
          npm run build || exit 1
          
          echo "Running PHPCBF for code quality check..."
          set +e
          ./vendor/bin/phpcbf . -d memory_limit=1024M
          result=$?
          if [ $result -ne 0 ]; then
            echo "PHPCBF found some issues but continuing deployment..."
          fi
          set -e
          
          echo "Preparing build artifacts..."
          rm -rf vendor node_modules .github .git .gitignore package-lock.json package.json composer.json composer.lock
          
          echo "Deploying artifacts to the master-build branch..."
          git init
          git config user.name "Shubham Kumar Bansal"
          git config user.email "shub@shubkb.com"
          git add .
          git commit -m "Deploy build: $(date +'%Y-%m-%d %H:%M:%S')"
          git branch -M master-build
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push --force origin master-build
